name: Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name to publish'
        required: true
      metabase-version:
        description: 'Metabase version'
        required: false
        type: string
        default: 'v0.48.0'

jobs:
  build-driver:
    uses: ./.github/workflows/build-driver.yml
    with:
      metabase-version: ${{ github.event.inputs.metabase-version || 'v0.48.0' }}
      branch: ${{ github.event.release.tag_name || github.event.inputs.tag_name }}
  publish:
    runs-on: ubuntu-latest
    needs: [build-driver]
    steps:
      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v6
        id: import_gpg
        with:
          gpg_private_key: ${{ secrets.GRADLE_SIGNING_KEY }}
          passphrase: ${{ secrets.GRADLE_SIGNING_PASSWORD }}
      - name: "Maven deploy"
        env:
          SIGN_KEY_ID: ${{ steps.import_gpg.outputs.keyid }}
          MAVEN_REPO_USERNAME: ${{ secrets.MAVEN_REPO_USERNAME }}
          MAVEN_REPO_PASSWORD: ${{ secrets.MAVEN_REPO_PASSWORD }}
        run: |
          lein deploy

      - uses: xresloader/upload-to-github-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          file: ${{ needs.build-driver.outputs.jar-name }}
          tags: true
          draft: false
